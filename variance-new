#!/bin/bash

# Variance Launcher
# Supports multiple rendering modes:
#   --tui     : Python TUI only (fast, deterministic)
#   --hybrid  : Python TUI + Gemini commentary
#   --gemini  : Original Gemini-only mode (default)

MODE="gemini"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --tui)
            MODE="tui"
            shift
            ;;
        --hybrid)
            MODE="hybrid"
            shift
            ;;
        --gemini)
            MODE="gemini"
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: ./variance [--tui|--hybrid|--gemini]"
            exit 1
            ;;
    esac
done

# Find latest portfolio
LATEST_CSV=$(ls -t positions/tastytrade_positions_*.csv 2>/dev/null | head -1)

if [ -z "$LATEST_CSV" ]; then
    echo "Error: No portfolio CSV found in positions/" >&2
    exit 1
fi

case "$MODE" in
    tui)
        # Python TUI only - fast & deterministic
        echo "Mode: Python TUI (deterministic)" >&2
        echo "Portfolio: $(basename $LATEST_CSV)" >&2
        echo "" >&2
        ./venv/bin/python3 scripts/analyze_portfolio.py "$LATEST_CSV" 2>/dev/null | \
        ./venv/bin/python3 scripts/tui_renderer.py
        ;;

    hybrid)
        # Python TUI + Gemini commentary
        echo "Mode: Hybrid (Python TUI + Gemini)" >&2
        echo "Portfolio: $(basename $LATEST_CSV)" >&2
        echo "" >&2

        JSON_FILE="/tmp/variance_$$.json"
        ./venv/bin/python3 scripts/analyze_portfolio.py "$LATEST_CSV" 2>/dev/null > "$JSON_FILE"

        # Show Python TUI
        ./venv/bin/python3 scripts/tui_renderer.py "$JSON_FILE"

        # Get Gemini commentary
        echo "" >&2
        echo "━━━ Strategic Commentary ━━━" >&2
        cat "$JSON_FILE" | gemini -y "Provide concise trading recommendations based on this JSON. Focus on priorities."
        rm -f "$JSON_FILE"
        ;;

    gemini)
        # Original Gemini-only mode
        echo "Mode: Gemini (interactive)" >&2
        exec gemini -y -i "Variance, analyze the latest portfolio positions and identify actionable trades based on current market conditions and trading rules."
        ;;
esac
