#!/bin/bash

# Variance Smart Wrapper
# Handles environment setup and simplifies command usage.

VENV_DIR="venv"
PYTHON="$VENV_DIR/bin/python3"
PIP="$VENV_DIR/bin/pip"

# Ensure script is run from project root
if [ ! -f "scripts/analyze_portfolio.py" ]; then
    echo "Error: Please run this script from the project root directory."
    exit 1
fi

# 1. Environment Check & Setup
if [ ! -d "$VENV_DIR" ]; then
    echo "Initializing Variance environment..."
    python3 -m venv "$VENV_DIR"
    "$PIP" install -r requirements.txt
    echo "Setup complete."
    echo "----------------------------------------------------------------"
fi

# 2. Helper: Find Latest CSV
get_latest_position_file() {
    # Check if positions directory exists
    if [ -d "positions" ]; then
        # Find latest csv, suppress errors if empty
        LATEST=$(ls -t positions/*.csv 2>/dev/null | head -n 1)
        if [ -n "$LATEST" ]; then
            echo "$LATEST"
            return
        fi
    fi
    # Fallback
    echo "util/sample_positions.csv"
}

# 3. Command Routing
COMMAND=$1

case "$COMMAND" in
    "screen")
        shift
        "$PYTHON" scripts/vol_screener.py "$@"
        ;;
    "triage")
        shift
        # Check if first arg is a file
        TARGET_FILE=""
        if [ -f "$1" ]; then
            TARGET_FILE="$1"
            shift
        else
            TARGET_FILE=$(get_latest_position_file)
            echo "Auto-detected Portfolio: $TARGET_FILE"
        fi
        "$PYTHON" scripts/analyze_portfolio.py "$TARGET_FILE" "$@"
        ;;
    "help"|"--help"|"-h")
        echo "Variance CLI"
        echo "Usage: ./variance [command] [options]"
        echo ""
        echo "Commands:"
        echo "  (empty)       Run Portfolio Triage on the latest CSV (default JSON)"
        echo "  screen        Run the Volatility Screener"
        echo "  triage [file] Run Portfolio Triage on a specific file"
        echo "  help          Show this message"
        echo ""
        echo "Options:"
        echo "  --text        Output human-readable text instead of JSON"
        echo ""
        echo "Examples:"
        echo "  ./variance --text"
        echo "  ./variance screen --text 10"
        echo "  ./variance triage positions/my_export.csv --text"
        ;;
    *)
        # Default behavior: Triage latest file
        # Pass all arguments to the script (e.g. --text)
        FILE=$(get_latest_position_file)
        # Check if arguments were passed, if so print what we are doing
        if [ -n "$*" ]; then
             echo "Auto-detected Portfolio: $FILE"
        elif [ -t 1 ]; then
             # If running in terminal and no args, mention --text
             echo "Running Triage on: $FILE (JSON output)" >&2
             echo "Tip: Use --text for human-readable output." >&2
        fi
        "$PYTHON" scripts/analyze_portfolio.py "$FILE" "$@"
        ;;
esac
