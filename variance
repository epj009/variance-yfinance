#!/bin/bash

# VARIANCE: The Unified Launcher
# Usage:
#   ./variance          # Default: Hybrid Mode (TUI + Interactive Strategy)
#   ./variance --tui    # TUI Only (Fast, Deterministic)
#   ./variance --chat   # Chat Only (No pre-analysis)
#   ./variance --debug  # Show diagnostics panels in the TUI

# Auto-load Tastytrade credentials if available
if [ -f .env.tastytrade ]; then
    source .env.tastytrade
fi

# Auto-load Anthropic API key if available
if [ -f .env.anthropic ]; then
    source .env.anthropic
fi

MODE="hybrid"
AGENT="gemini"  # Default agent (gemini or claude)
SHOW_DIAGNOSTICS=0

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --tui)
            MODE="tui"
            shift
            ;;
        --demo)
            MODE="demo"
            shift
            ;;
        --gemini)
            AGENT="gemini"
            MODE="hybrid"
            shift
            ;;
        --claude)
            AGENT="claude"
            MODE="hybrid"
            shift
            ;;
        --chat)
            MODE="chat"
            shift
            ;;
        --hybrid)
            MODE="hybrid"
            shift
            ;;
        --debug|--diag)
            SHOW_DIAGNOSTICS=1
            shift
            ;;
        --agent)
            AGENT="$2"
            shift 2
            ;;
        -h|--help)
            echo "Usage: ./variance [options]"
            echo "Options:"
            echo "  --tui       Run Python TUI dashboard only (fast)"
            echo "  --debug     Show diagnostics panels"
            echo "  --gemini    Run full analysis with Gemini (TUI + AI)"
            echo "  --claude    Run full analysis with Claude (TUI + AI)"
            echo "  --chat      Run chat only with default agent (no analysis)"
            echo "  --hybrid    Run TUI then start interactive strategy session (default)"
            echo "  --agent     Override agent: gemini|claude (default: gemini)"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage."
            exit 1
            ;;
    esac
done

# Find latest portfolio CSV
# Priority: tastytrade_positions_*.csv -> *.csv
LATEST_CSV=$(ls -t positions/tastytrade_positions_*.csv 2>/dev/null | head -1)

if [ -z "$LATEST_CSV" ]; then
    # Fallback: Try any CSV
    LATEST_CSV=$(ls -t positions/*.csv 2>/dev/null | head -1)
fi

if [ -z "$LATEST_CSV" ]; then
    echo "Error: No portfolio CSV found in positions/" >&2
    exit 1
fi

# Define report files
# The analysis JSON is stored in reports/ to be accessible to the Gemini CLI.
JSON_FILE="reports/variance_analysis.json"
TUI_FILE="reports/variance_tui_output.txt"

# Spinner function for long-running analysis
spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while [ "$(ps -p $pid -o state=)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# Wait for JSON file to be fully written before rendering.
wait_for_json() {
    local file="$1"
    local attempts=20
    local delay=0.1
    while [ $attempts -gt 0 ]; do
        if [ -s "$file" ]; then
            if ./venv/bin/python3 - <<PY >/dev/null 2>&1
import json
with open("$file", "r") as f:
    json.load(f)
PY
            then
                return 0
            fi
        fi
        attempts=$((attempts - 1))
        sleep $delay
    done
    return 1
}

# Execution Logic
case "$MODE" in
    tui)
        echo "╔════════════════════════════════════════════════════════════════╗" >&2
        echo "║  VARIANCE: TUI MODE                                            ║" >&2
        echo "║  Portfolio: $(basename $LATEST_CSV)                            " >&2
        echo "╚════════════════════════════════════════════════════════════════╝" >&2
        printf "Analyzing... " >&2
        
        # Log file for errors
        LOG_FILE="logs/variance_error.log"
        : > "$LOG_FILE"

        # Run analysis pipe directly in background for spinner
        ANALYSIS_ARGS=("$LATEST_CSV")
        if [ "$SHOW_DIAGNOSTICS" -eq 1 ]; then
            ANALYSIS_ARGS+=("--diag")
        fi
        # Export Tastytrade credentials if set
        export TT_CLIENT_ID TT_CLIENT_SECRET TT_REFRESH_TOKEN API_BASE_URL
        (./venv/bin/python3 scripts/analyze_portfolio.py "${ANALYSIS_ARGS[@]}" > "$JSON_FILE" 2> "$LOG_FILE") &
        spinner $!
        echo "Done." >&2
        echo "" >&2
        
        if wait_for_json "$JSON_FILE"; then
            TUI_ARGS=("$JSON_FILE")
            if [ "$SHOW_DIAGNOSTICS" -eq 1 ]; then
                TUI_ARGS+=("--diag")
            fi
            ./venv/bin/python3 scripts/tui_renderer.py "${TUI_ARGS[@]}"
        else
            echo "Error: Analysis JSON not ready or invalid." >&2
            if [ -s "$LOG_FILE" ]; then
                echo "--- Error Details ---" >&2
                cat "$LOG_FILE" >&2
                echo "---------------------" >&2
            fi
            echo "Try rerunning." >&2
            exit 1
        fi
        ;;

    demo)
        DEMO_CSV="util/showcase_portfolio.csv"
        echo "╔════════════════════════════════════════════════════════════════╗" >&2
        echo "║  VARIANCE: SHOWCASE DEMO MODE                                  ║" >&2
        echo "║  Testing institutional logic gates...                          ║" >&2
        echo "╚════════════════════════════════════════════════════════════════╝" >&2
        printf "Initializing Showcase Engine... " >&2
        
        # Log file for errors
        LOG_FILE="logs/variance_error.log"
        : > "$LOG_FILE" # Clear log

        # Run analysis on showcase file
        ANALYSIS_ARGS=("$DEMO_CSV")
        if [ "$SHOW_DIAGNOSTICS" -eq 1 ]; then
            ANALYSIS_ARGS+=("--diag")
        fi
        # Export Tastytrade credentials if set
        export TT_CLIENT_ID TT_CLIENT_SECRET TT_REFRESH_TOKEN API_BASE_URL
        (./venv/bin/python3 scripts/analyze_portfolio.py "${ANALYSIS_ARGS[@]}" > "$JSON_FILE" 2> "$LOG_FILE") &
        spinner $!
        echo "Done." >&2
        echo "" >&2
        
        if wait_for_json "$JSON_FILE"; then
            TUI_ARGS=("$JSON_FILE")
            if [ "$SHOW_DIAGNOSTICS" -eq 1 ]; then
                TUI_ARGS+=("--diag")
            fi
            ./venv/bin/python3 scripts/tui_renderer.py "${TUI_ARGS[@]}"
        else
            echo "Error: Analysis JSON not ready or invalid." >&2
            if [ -s "$LOG_FILE" ]; then
                echo "--- Error Details ---" >&2
                cat "$LOG_FILE" >&2
                echo "---------------------" >&2
            fi
            echo "Try rerunning." >&2
            exit 1
        fi
        ;;

    hybrid)
        echo "╔════════════════════════════════════════════════════════════════╗" >&2
        echo "║  VARIANCE: STRATEGY MODE                                       ║" >&2
        echo "║  Portfolio: $(basename $LATEST_CSV)                            " >&2
        echo "╚════════════════════════════════════════════════════════════════╝" >&2
        printf "Generating analysis... " >&2

        # Log file for errors
        LOG_FILE="logs/variance_error.log"
        : > "$LOG_FILE"

        # 1. Generate Data in background
        ANALYSIS_ARGS=("$LATEST_CSV")
        if [ "$SHOW_DIAGNOSTICS" -eq 1 ]; then
            ANALYSIS_ARGS+=("--diag")
        fi
        # Export Tastytrade credentials if set
        export TT_CLIENT_ID TT_CLIENT_SECRET TT_REFRESH_TOKEN API_BASE_URL
        (./venv/bin/python3 scripts/analyze_portfolio.py "${ANALYSIS_ARGS[@]}" > "$JSON_FILE" 2> "$LOG_FILE") &
        spinner $!
        echo "Done." >&2

        # 2. Render TUI to console AND file
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
        echo " PORTFOLIO DASHBOARD" >&2
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
        if wait_for_json "$JSON_FILE"; then
            TUI_ARGS=("$JSON_FILE")
            if [ "$SHOW_DIAGNOSTICS" -eq 1 ]; then
                TUI_ARGS+=("--diag")
            fi
            ./venv/bin/python3 scripts/tui_renderer.py "${TUI_ARGS[@]}" | tee "$TUI_FILE"
        else
            echo "Error: Analysis JSON not ready or invalid." >&2
            if [ -s "$LOG_FILE" ]; then
                echo "--- Error Details ---" >&2
                cat "$LOG_FILE" >&2
                echo "---------------------" >&2
            fi
            echo "Try rerunning." >&2
            exit 1
        fi

        # 3. Launch Selected Agent
        echo "" >&2
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2

        if [ "$AGENT" = "claude" ]; then
            echo " STRATEGIC ANALYSIS (Claude)" >&2
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2

            # Load persona and build context
            PERSONA=$(cat config/claude_persona.md 2>/dev/null || echo "You are Variance, a quantitative trading strategist.")
            TUI_CONTENT=$(cat "$TUI_FILE" 2>/dev/null || echo "[TUI output not available]")

            # Launch Claude CLI with system prompt
            exec claude --system-prompt "$PERSONA" "# Portfolio Dashboard

$TUI_CONTENT

# Analysis Data
Full analysis JSON: $JSON_FILE

# Your Task
Analyze the dashboard and provide strategic commentary on:
1. Triage priorities (harvest, defense, gamma risks)
2. Portfolio balance (delta/theta, concentration)
3. Opportunities from the screener

Then remain interactive for follow-up questions."
        else
            echo " STRATEGIC ANALYSIS (Gemini)" >&2
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
            exec gemini -y -i "First, display the Variance TUI dashboard by running: cat $TUI_FILE

Then provide strategic commentary on:
1. Priority actions from the triage (harvest, defense, gamma risks)
2. Delta/theta balance concerns
3. Top opportunities from the vol screener

The full analysis JSON is at $JSON_FILE if you need detailed data.

Then stay interactive for follow-up questions about the portfolio."
        fi
        ;;

    chat)
        if [ "$AGENT" = "claude" ]; then
            echo "Starting Claude Chat..." >&2
            PERSONA=$(cat config/claude_persona.md 2>/dev/null || echo "You are Variance, a quantitative trading strategist.")
            exec claude --system-prompt "$PERSONA" "Analyze the latest portfolio positions and identify actionable trades based on current market conditions and trading rules."
        else
            echo "Starting Gemini Chat..." >&2
            exec gemini -y -i "Variance, analyze the latest portfolio positions and identify actionable trades based on current market conditions and trading rules."
        fi
        ;;
esac
