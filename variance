#!/bin/bash
set -e

# Configuration
VENV_DIR="./venv"
PYTHON="$VENV_DIR/bin/python3"
PIP="$VENV_DIR/bin/pip"
REQUIREMENTS="requirements.txt"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

log() {
    echo -e "${CYAN}[variance]${NC} $1"
}

# 1. Environment Check & Bootstrap
ensure_env() {
    if [ ! -d "$VENV_DIR" ]; then
        log "First run detected. Initializing virtual environment..."
        python3 -m venv "$VENV_DIR"
        log "Installing dependencies..."
        "$PIP" install -q -r "$REQUIREMENTS"
        log "Setup complete. Ready."
        echo ""
    fi
}

# 2. Helper: Find Latest Portfolio File
get_latest_portfolio() {
    # Lists files in positions/, sorts by time (newest first), takes top 1
    # 2>/dev/null suppresses error if directory is empty
    ls -t positions/*.csv 2>/dev/null | head -n 1
}

# 3. Command Routing
show_help() {
    echo "Usage: ./variance [command] [args]"
    echo ""
    echo "Commands:"
    echo "  (no args)       Auto-Triage: Process the latest positions file"
    echo "  triage [file]   Run portfolio analysis manually"
    echo "  screen [args]   Run volatility screener"
    echo "  setup           Force environment recreation"
    echo "  test            Run unit tests"
    echo ""
    echo "Examples:"
    echo "  ./variance"
    echo "  ./variance screen --exclude-asset-classes Equity"
    echo "  ./variance triage positions/my_export.csv"
}

# Main Logic
case "$1" in
    "triage")
        ensure_env
        shift
        file="$1"
        if [ -z "$file" ]; then
            file=$(get_latest_portfolio)
            if [ -z "$file" ]; then
                file="util/sample_positions.csv"
                log "No positions found. Using sample."
            else
                log "Selected latest file: $file"
            fi
        fi
        "$PYTHON" scripts/analyze_portfolio.py "$file"
        ;;
    
    "screen")
        ensure_env
        shift
        "$PYTHON" scripts/vol_screener.py "$@"
        ;;
    
    "setup")
        log "Recreating environment..."
        rm -rf "$VENV_DIR"
        ensure_env
        ;;
    
    "test")
        ensure_env
        "$VENV_DIR/bin/pytest" -q
        ;;

    "help"|"--help"|"-h")
        show_help
        ;;
        
    *)
        # Default Behavior: Boot & Auto-Triage
        ensure_env
        log "Initializing Variance Engine..."
        
        latest_file=$(get_latest_portfolio)
        
        if [ -n "$latest_file" ]; then
            log "Processing latest positions: $latest_file"
            "$PYTHON" scripts/analyze_portfolio.py "$latest_file"
        else
            log "No positions file found in positions/. Running sample diagnostics..."
            "$PYTHON" scripts/analyze_portfolio.py "util/sample_positions.csv"
        fi
        ;;
esac
