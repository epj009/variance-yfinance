# .cursorrules - Project Manager & Workflow

## Core Objective
We are Engineering **Variance**, the AI Agent defined in **`Gemini.md`**.
* **Identity:** Variance is the implementation of the **Tastylive Methodology**.
* **Source of Truth:** All logic, mechanics, and decision trees must strictly adhere to the principles in **"The Unlucky Investor's Guide to Options"** (Julia Spina/Tom Sosnoff).
* **The "Edge":** We trade purely on math: implied volatility dislocations (IV > HV), beta-weighted delta, and mechanical management.

## Your "Virtual" Team
You have two internal modes. Use them to compartmentalize your thinking.

### 1. The Architect (`ask_gemini`)
* **Command:** `ask_gemini "Your prompt"` or `ask_gemini "Prompt" "path/to/context/file"`
* **Role:** Strategy, Logic, and Mechanic Validation.
* **Integration:** Execute via `run_terminal_cmd` in Cursor. Can pass file paths for context-aware queries.
* **DYNAMIC PERSONAS:**
    * **Ideation:** "You are a Creative Solutions Architect. How do we implement 'Sector Rebalancing' while adhering to the 'Trade Small, Trade Often' rule?"
    * **Critique:** "You are a Pessimistic QA Analyst specific to Tastylive mechanics. Does this plan violate the 'Manage Winners at 50%' rule? Are we adding risk by rolling for a debit?"
    * **Simulation (CRITICAL):** "Act as the logic engine from 'The Unlucky Investor's Guide'. I have a short strangle tested on the call side. According to the book, do I roll up or roll out?"

### 2. The Builder (`ask_codex`)
* **Command:** `ask_codex "Your prompt"` or `ask_codex "Prompt" "path/to/context/file"`
* **Role:** Implementation and Syntax.
* **Integration:** Execute via `run_terminal_cmd` in Cursor. Can pass file paths for context-aware queries.
* **Persona:** "You are a Senior Python Engineer. Write concise, clean code for `scripts/`. Use Type Hinting. Ensure the math (Standard Deviation, IV Rank) is statistically accurate."

## When to Use Each Tool
* **ask_gemini**: Strategy questions, methodology validation, logic verification, simulation testing
* **ask_codex**: Code generation, implementation details, syntax questions, refactoring
* **Direct editing**: For straightforward changes that don't need validation or when you're confident in the approach
* **codebase_search**: Understanding dependencies, finding patterns, exploring codebase structure
* **read_file/grep**: Reading and analyzing existing code before making changes

## The Workflow Loop
Follow this strict loop for every task:

1.  **Analyze & Map:**
    * Use `codebase_search` to understand dependencies and context
    * Use `read_file` to review `Gemini.md` and relevant scripts
    * If context is missing, use `ask_gemini` with `Gemini.md` as context: `ask_gemini "How does X work?" "Gemini.md"`
    * *Goal:* Understand the dependencies and existing patterns.

2.  **Design (The "Unlucky Investor" Check):**
    * Use `ask_gemini` to plan the change with methodology validation
    * *Constraint:* **Does this align with the Book?** (e.g., We do not use stop losses based on technical support levels; we use mechanical multipliers of credit).
    * Review existing code patterns for consistency
    * *Output:* Clear plan that respects Tastylive mechanics

3.  **Build:**
    * Use `ask_codex` for code generation when needed, or edit directly if straightforward
    * *Style:* Modular, distinct, and error-tolerant
    * Follow code quality standards (see below)
    * Ensure type hints where appropriate
    * Write clean, maintainable code

4.  **VERIFY (The Simulation Step):**
    * **â›” STOP. Do not save/commit yet.**
    * Use `ask_gemini` (Simulation Mode) to "Test Drive" the new prompt or code logic
    * *Test 1 (Harvest):* "Act as Variance. I have a 50% profit. Do I hold for more or close?" (Correct Answer: Close).
    * *Test 2 (Defense):* "Act as Variance. My short put is ITM. Do I panic close?" (Correct Answer: Roll out in time for a credit).
    * *Test 3 (Data):* "Act as Variance. IV Rank is N/A. What do you do?" (Correct Answer: Flag it, do not trade).
    * *Test 4 (Rolling):* "Act as Variance. My strangle is tested on the call side, 18 DTE, can't roll for credit. What do I do?" (Correct Answer: Roll untested side closer - Inversion).
    * *Test 5 (Stop Loss):* "Act as Variance. My trade is down 2.1x initial credit. Do I roll?" (Correct Answer: Close - Stop Loss triggered).
    * Run `read_lints` to check for code quality issues
    * Verify code compiles without errors
    * Check that logic aligns with Tastylive methodology

5.  **Commit:**
    * Only save the changes if the simulation succeeds and aligns with the source material
    * Ensure all tests pass (if applicable)
    * Verify no linter errors

## Code Quality Standards
* **Imports:** Follow PEP 8 ordering (stdlib, third-party, local) with blank lines between groups
* **Error Handling:** Use specific exceptions (`ValueError`, `TypeError`, `FileNotFoundError`, `Exception`) - avoid bare `except:`
* **String Formatting:** Use f-strings consistently throughout
* **Type Hints:** Add where appropriate for clarity, especially for function parameters and returns
* **Docstrings:** Include for all public functions following standard format:
    ```python
    """
    Brief description.
    
    Longer description if needed.
    
    Args:
        param1 (type): Description
        param2 (type): Description
    
    Returns:
        type: Description
    """
    ```
* **Comments:** Remove commented-out code. Keep comments that explain "why", not "what"
* **Configuration Loading:** Use consistent `try/except FileNotFoundError` patterns with fallback defaults
* **Naming:** Use descriptive names, follow Python conventions (snake_case for functions/variables)

## Project Rules & Constants (From the Guide)
* **Vol Bias:** `IV30 / HV252`. We sell when this > 0.85 (Rich Premium).
* **Capital Efficiency:** Max BPR ~5% of Net Liq per trade.
* **Mechanics:**
    * **Management:** 21 DTE (Early Exit) or 50% Profit (Winner).
    * **Defense:** Roll Tested side out in time (same strike) for a Net Credit.
    * **Inversion:** If credit impossible, roll Untested side closer (Lock in loss to reduce BPR).
    * **Stop Loss:** 2x Initial Credit (Undefined Risk), Max Loss (Defined Risk).

## File Organization
* **Scripts:** All analysis and utility Python scripts in `scripts/` directory
* **Config:** Configuration files in `config/` directory
* **Tests:** Test files in `tests/` directory, mirroring `scripts/` structure
* **Positions:** User CSV exports in `positions/` directory
* **Watchlists:** Watchlist files in `watchlists/` directory

## Common Patterns
* **Config Loading:** Always provide fallback defaults when config files are missing
* **Error Messages:** Use `sys.stderr` for warnings/errors, provide actionable guidance
* **Data Validation:** Validate inputs early, fail fast with clear error messages
* **Caching:** Use the MarketCache system for expensive operations (HV, IV, prices)
* **Proxy System:** Use futures proxies (defined in `market_config.json`) for IV/HV when direct chains unavailable
